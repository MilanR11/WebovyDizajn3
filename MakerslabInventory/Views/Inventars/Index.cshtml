@model IEnumerable<MakerslabInventory.Models.Inventar>
@using MakerslabInventory.Models

@{
    ViewData["Title"] = "Inventár";
}

<h1>Inventár</h1>

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        @if (User.IsInRole("Admin") || User.IsInRole("Ucitel"))
        {
            <a asp-action="Create" class="btn btn-primary">Pridať novú položku</a>
            <a asp-action="ExportToExcel" class="btn btn-success ms-2">Export do Excelu</a>
        }
    </div>
</div>

<!-- Vyhľadávací a filtračný formulár -->
<form asp-action="Index" method="get" class="mb-4">
    <div class="row g-3 align-items-end">
        <div class="col-auto">
            <label class="form-label">Hľadať:</label>
            <input type="text" name="searchString" value="@ViewData["CurrentFilter"]" class="form-control" placeholder="Názov, kategória..." />
        </div>
        <div class="col-auto">
            <label class="form-label">Stav:</label>
            <select name="inventoryState" asp-items="Html.GetEnumSelectList<StavInventara>()" class="form-select">
                <option value="">-- Všetky stavy --</option>
                @if (ViewData["CurrentStateFilter"]?.ToString() == "NizkaZasoba")
                {
                    <option value="NizkaZasoba" selected>Nízka zásoba</option>
                }
                else
                {
                    <option value="NizkaZasoba">Nízka zásoba</option>
                }
            </select>
        </div>
        <div class="col-auto">
            <button type="submit" class="btn btn-secondary">Filtrovať</button>
            <a asp-action="Index" class="btn btn-outline-secondary">Zrušiť filter</a>
        </div>
    </div>
</form>

<table class="table table-striped table-hover">
    <thead>
        <tr>
            <th>
                <a asp-action="Index" asp-route-sortOrder="@ViewData["NameSortParm"]" asp-route-searchString="@ViewData["CurrentFilter"]">
                    @Html.DisplayNameFor(model => model.Nazov)
                </a>
            </th>
            <th>
                <a asp-action="Index" asp-route-sortOrder="@ViewData["CategorySortParm"]" asp-route-searchString="@ViewData["CurrentFilter"]">
                    @Html.DisplayNameFor(model => model.Kategoria)
                </a>
            </th>
            <th>@Html.DisplayNameFor(model => model.Mnozstvo)</th>
            <th>@Html.DisplayNameFor(model => model.Lokalita)</th>
            <th>@Html.DisplayNameFor(model => model.Stav)</th>
            <th>Akcie</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model)
        {
            // Zvýraznenie nízkej zásoby
            var rowClass = (item.Mnozstvo <= item.MinMnozstvo) ? "table-warning" : "";
            <tr class="@rowClass">
                <td>@Html.DisplayFor(modelItem => item.Nazov)</td>
                <td>@Html.DisplayFor(modelItem => item.Kategoria)</td>
                <td>
                    @Html.DisplayFor(modelItem => item.Mnozstvo) @Html.DisplayFor(modelItem => item.Jednotka)
                </td>
                <td>@Html.DisplayFor(modelItem => item.Lokalita)</td>
                <td>
                    @if (item.Stav == StavInventara.Vypožičaný)
                    {
                        <span class="badge bg-warning text-dark">Vypožičané (@item.ZapozicaneKomu)</span>
                    }
                    else if (item.Mnozstvo <= item.MinMnozstvo)
                    {
                        <span class="badge bg-danger">Nízka zásoba</span>
                    }
                    else
                    {
                        <span class="badge bg-success">Dostupné</span>
                    }
                </td>
                <td>
                    <div class="btn-group" role="group">
                        @if (User.IsInRole("Admin") || User.IsInRole("Ucitel"))
                        {
                            <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-sm btn-warning" title="Upraviť">✏️</a>
                        }

                        <!-- TOTO JE ZMENA: Tlačidlo Detail už nie je odkaz, ale otvára Modal -->
                        <button type="button" 
                                class="btn btn-sm btn-info text-white" 
                                onclick="openDetailsModal(@item.Id)" 
                                title="Detail">
                            ℹ️
                        </button>

                        @if (User.IsInRole("Admin") || User.IsInRole("Ucitel"))
                        {
                            <a asp-action="Delete" asp-route-id="@item.Id" class="btn btn-sm btn-danger" title="Zmazať">🗑️</a>
                            
                            @if (item.Stav != StavInventara.Vypožičaný)
                            {
                                <a asp-action="Pozicat" asp-route-id="@item.Id" class="btn btn-sm btn-primary ms-1">Požičať</a>
                            }
                            else
                            {
                                <form asp-action="Vratit" asp-route-id="@item.Id" method="post" style="display:inline;" onsubmit="return confirm('Potvrdiť vrátenie?');">
                                    <button type="submit" class="btn btn-sm btn-success ms-1">Vrátiť</button>
                                </form>
                            }
                        }
                    </div>
                </td>
            </tr>
        }
    </tbody>
</table>

<!-- ========================================== -->
<!-- MODÁLNE OKNO (Vyskakovacie okno)           -->
<!-- ========================================== -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg"> <!-- modal-lg robí okno širším -->
        <div class="modal-content" id="modalContentContainer">
            <!-- Sem sa načíta obsah cez AJAX -->
            <div class="modal-body text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Načítavam...</span>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Funkcia, ktorá sa zavolá po kliknutí na tlačidlo Detail
        function openDetailsModal(id) {
            // 1. Nájdeme modal v HTML
            var myModalElement = document.getElementById('detailsModal');
            
            // --- OPRAVA: Presunieme modal na koniec body, aby nebol prekrytý sivým pozadím ---
            document.body.appendChild(myModalElement);
            // -------------------------------------------------------------------------------

            var myModal = new bootstrap.Modal(myModalElement);

            // 2. Ukážeme modal (zatiaľ s točiacim sa kolieskom)
            myModal.show();
            
            // Reset obsahu na spinner
            $('#modalContentContainer').html(
                '<div class="modal-body text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Načítavam...</span></div></div>'
            );

            // 3. Stiahneme dáta zo servera
            $.ajax({
                url: '/Inventars/Details/' + id,
                type: 'GET',
                success: function (result) {
                    // Vložíme stiahnutý HTML kód do modalu
                    $('#modalContentContainer').html(result);
                },
                error: function () {
                    $('#modalContentContainer').html(
                        '<div class="modal-header"><h5 class="modal-title text-danger">Chyba</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>' +
                        '<div class="modal-body text-danger">Nepodarilo sa načítať detaily položky.</div>'
                    );
                }
            });
        }
    </script>
}

