@model IEnumerable<MakerslabInventory.Models.Inventar>
@using MakerslabInventory.Models

@{
    ViewData["Title"] = "Inventár";
}

<h1>Inventár</h1>

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        @if (User.IsInRole("Admin") || User.IsInRole("Ucitel"))
        {
            <a asp-action="Create" class="btn btn-primary">Pridať novú položku</a>
            <a asp-action="ExportToExcel" class="btn btn-success ms-2">Export do Excelu</a>
        }
    </div>
</div>

@* Skrytý formulár len kvôli AntiForgery tokenu pre AJAX *@
<form id="antiForgeryForm" method="post" style="display:none;">
    @Html.AntiForgeryToken()
    <input type="submit" />
    <!-- submit tu nikdy nepoužijeme, ide len o vloženie tokenu do DOMu -->
}</form>

<!-- Vyhľadávací a filtračný formulár -->
<form asp-action="Index" method="get" class="mb-4">
    <div class="row g-3 align-items-end">
        <div class="col-auto">
            <label class="form-label">Hľadať:</label>
            <input type="text" name="searchString" value="@ViewData["CurrentFilter"]" class="form-control" placeholder="Názov, kategória..." />
        </div>
        <div class="col-auto">
            <label class="form-label">Stav:</label>
            <select name="inventoryState" asp-items="Html.GetEnumSelectList<StavInventara>()" class="form-select">
                <option value="">-- Všetky stavy --</option>
                @if (ViewData["CurrentStateFilter"]?.ToString() == "NizkaZasoba")
                {
                    <option value="NizkaZasoba" selected>Nízka zásoba</option>
                }
                else
                {
                    <option value="NizkaZasoba">Nízka zásoba</option>
                }
            </select>
        </div>
        <div class="col-auto">
            <button type="submit" class="btn btn-secondary">Filtrovať</button>
            <a asp-action="Index" class="btn btn-outline-secondary">Zrušiť filter</a>
        </div>
    </div>
</form>

<table class="table table-striped table-hover">
    <thead>
        <tr>
            <th>
                <a asp-action="Index" asp-route-sortOrder="@ViewData["NameSortParm"]" asp-route-searchString="@ViewData["CurrentFilter"]">
                    @Html.DisplayNameFor(model => model.Nazov)
                </a>
            </th>
            <th>
                <a asp-action="Index" asp-route-sortOrder="@ViewData["CategorySortParm"]" asp-route-searchString="@ViewData["CurrentFilter"]">
                    @Html.DisplayNameFor(model => model.Kategoria)
                </a>
            </th>
            <th>@Html.DisplayNameFor(model => model.Mnozstvo)</th>
            <th>@Html.DisplayNameFor(model => model.Lokalita)</th>
            <th>@Html.DisplayNameFor(model => model.Stav)</th>
            <th>Akcie</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model)
        {
            // Zvýraznenie nízkej zásoby
            var rowClass = (item.Mnozstvo <= item.MinMnozstvo) ? "table-warning" : "";
            <tr class="@rowClass" data-item-id="@item.Id">
                <td>@Html.DisplayFor(modelItem => item.Nazov)</td>
                <td>@Html.DisplayFor(modelItem => item.Kategoria)</td>
                <td>
                    @if (User.IsInRole("Admin") || User.IsInRole("Ucitel"))
                    {
                        <div class="d-flex align-items-center gap-1">
                            <input type="number"
                                   id="qty-input-@item.Id"
                                   class="form-control form-control-sm"
                                   style="width: 110px;"
                                   min="0"
                                   value="@item.Mnozstvo" />
                            <span class="text-muted">@item.Jednotka</span>
                            <button type="button" class="btn btn-sm btn-outline-primary" title="Uložiť množstvo" onclick="saveQty(@item.Id)">Uložiť</button>
                        </div>
                        <small class="text-muted">Min: @item.MinMnozstvo, Max: @item.MaxMnozstvo</small>
                    }
                    else
                    {
                        @Html.DisplayFor(modelItem => item.Mnozstvo) @Html.DisplayFor(modelItem => item.Jednotka)
                    }
                </td>
                <td>@Html.DisplayFor(modelItem => item.Lokalita)</td>
                <td>
                    @if (item.Stav == StavInventara.Vypožičaný)
                    {
                        <span class="badge bg-warning text-dark status-badge">Vypožičané (@item.ZapozicaneKomu)</span>
                    }
                    else if (item.Mnozstvo <= item.MinMnozstvo)
                    {
                        <span class="badge bg-danger status-badge">Nízka zásoba</span>
                    }
                    else
                    {
                        <span class="badge bg-success status-badge">Dostupné</span>
                    }
                </td>
                <td>
                    <div class="btn-group" role="group">
                        @if (User.IsInRole("Admin") || User.IsInRole("Ucitel"))
                        {
                            <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-sm btn-warning" title="Upraviť">✏️</a>
                        }

                        <!-- TOTO JE ZMENA: Tlačidlo Detail už nie je odkaz, ale otvára Modal -->
                        <button type="button" 
                                class="btn btn-sm btn-info text-white" 
                                onclick="openDetailsModal(@item.Id)" 
                                title="Detail">
                            ℹ️
                        </button>

                        <a asp-action="Historia" asp-route-id="@item.Id" class="btn btn-sm btn-outline-secondary" title="História">🕘</a>

                        @if (User.IsInRole("Admin") || User.IsInRole("Ucitel"))
                        {
                            <a asp-action="Delete" asp-route-id="@item.Id" class="btn btn-sm btn-danger" title="Zmazať">🗑️</a>
                            
                            @if (item.Stav != StavInventara.Vypožičaný)
                            {
                                <a asp-action="Pozicat" asp-route-id="@item.Id" class="btn btn-sm btn-primary ms-1">Požičať</a>
                            }
                            else
                            {
                                <form asp-action="Vratit" asp-route-id="@item.Id" method="post" style="display:inline;" onsubmit="return confirm('Potvrdiť vrátenie?');">
                                    <button type="submit" class="btn btn-sm btn-success ms-1">Vrátiť</button>
                                </form>
                            }
                        }
                    </div>
                </td>
            </tr>
        }
    </tbody>
</table>

<!-- ========================================== -->
<!-- MODÁLNE OKNO (Vyskakovacie okno)           -->
<!-- ========================================== -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg"> <!-- modal-lg robí okno širším -->
        <div class="modal-content" id="modalContentContainer">
            <!-- Sem sa načíta obsah cez AJAX -->
            <div class="modal-body text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Načítavam...</span>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Funkcia, ktorá sa zavolá po kliknutí na tlačidlo Detail
        function openDetailsModal(id) {
            // 1. Nájdeme modal v HTML
            var myModalElement = document.getElementById('detailsModal');
            
            // --- OPRAVA: Presunieme modal na koniec body, aby nebol prekrytý sivým pozadím ---
            document.body.appendChild(myModalElement);
            // -------------------------------------------------------------------------------

            var myModal = new bootstrap.Modal(myModalElement);

            // 2. Ukážeme modal (zatiaľ s točiacim sa kolieskom)
            myModal.show();
            
            // Reset obsahu na spinner
            $('#modalContentContainer').html(
                '<div class="modal-body text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Načítavam...</span></div></div>'
            );

            // 3. Stiahneme dáta zo servera
            $.ajax({
                url: '/Inventars/Details/' + id,
                type: 'GET',
                success: function (result) {
                    // Vložíme stiahnutý HTML kód do modalu
                    $('#modalContentContainer').html(result);
                },
                error: function () {
                    $('#modalContentContainer').html(
                        '<div class="modal-header"><h5 class="modal-title text-danger">Chyba</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>' +
                        '<div class="modal-body text-danger">Nepodarilo sa načítať detaily položky.</div>'
                    );
                }
            });
        }

        // --- Ukladanie množstva cez AJAX ---
        function saveQty(id) {
            var input = document.getElementById('qty-input-' + id);
            if (!input) return;
            var qty = parseInt(input.value, 10);
            if (isNaN(qty) || qty < 0) {
                alert('Množstvo musí byť nezáporné číslo.');
                return;
            }

            // Anti-forgery token
            var tokenInput = document.querySelector('#antiForgeryForm input[name="__RequestVerificationToken"]');
            var token = tokenInput ? tokenInput.value : '';

            $.ajax({
                url: '/Inventars/UpdateQuantity',
                type: 'POST',
                headers: { 'RequestVerificationToken': token },
                data: { id: id, quantity: qty },
                success: function (resp) {
                    try {
                        // Aktualizuj triedu riadku podľa lowStock
                        var row = document.querySelector('tr[data-item-id="' + id + '"]');
                        if (row) {
                            if (resp.lowStock) {
                                row.classList.add('table-warning');
                            } else {
                                row.classList.remove('table-warning');
                            }
                            // Aktualizuj odznak stavu, len ak nie je vypožičané
                            var badge = row.querySelector('.status-badge');
                            if (badge && badge.classList.contains('bg-warning') === false) {
                                if (resp.lowStock) {
                                    badge.className = 'badge bg-danger status-badge';
                                    badge.textContent = 'Nízka zásoba';
                                } else {
                                    badge.className = 'badge bg-success status-badge';
                                    badge.textContent = 'Dostupné';
                                }
                            }
                        }
                    } catch (e) { /* noop */ }
                },
                error: function (xhr) {
                    alert('Nepodarilo sa uložiť množstvo: ' + (xhr.responseJSON?.message || xhr.statusText));
                }
            });
        }
    </script>
}

